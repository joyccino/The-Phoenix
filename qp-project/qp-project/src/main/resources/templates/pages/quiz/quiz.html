<!DOCTYPE html>
<html data-bs-theme="light" dir="ltr"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <!-- ===============================================-->
    <!--    Document Title-->
    <!-- ===============================================-->
    <title>Falcon | Dashboard &amp; Web App Template</title>


    <!-- ===============================================-->
    <!--    Favicons-->
    <!-- ===============================================-->
    <link rel="apple-touch-icon" sizes="180x180" href="../../../assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../assets/img/favicons/favicon-16x16.png">
    <link rel="shortcut icon" type="image/x-icon" href="../../../assets/img/favicons/favicon.ico">
    <link rel="manifest" href="../../../assets/img/favicons/manifest.json">
    <meta name="msapplication-TileImage" content="../../../assets/img/favicons/mstile-150x150.png">
    <meta name="theme-color" content="#ffffff">
    <script src="../../../assets/js/config.js"></script>
    <script src="../../../vendors/simplebar/simplebar.min.js"></script>


    <!-- ===============================================-->
    <!--    Stylesheets-->
    <!-- ===============================================-->
    <link href="../../../vendors/choices/choices.min.css" rel="stylesheet">
    <link href="../../../vendors/dropzone/dropzone.min.css" rel="stylesheet">
    <link href="../../../vendors/flatpickr/flatpickr.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700%7cPoppins:300,400,500,600,700,800,900&amp;display=swap" rel="stylesheet">
    <link href="../../../vendors/simplebar/simplebar.min.css" rel="stylesheet">
    <link href="../../../assets/css/theme-rtl.css" rel="stylesheet" id="style-rtl">
    <link href="../../../assets/css/theme.css" rel="stylesheet" id="style-default">
    <link href="../../../assets/css/user-rtl.css" rel="stylesheet" id="user-style-rtl">
    <link href="../../../assets/css/user.css" rel="stylesheet" id="user-style-default">

    <link href="../../../vendors/prism/prism-okaidia.css" rel="stylesheet">
    <script>
      var isRTL = JSON.parse(localStorage.getItem('isRTL'));
      if (isRTL) {
        var linkDefault = document.getElementById('style-default');
        var userLinkDefault = document.getElementById('user-style-default');
        linkDefault.setAttribute('disabled', true);
        userLinkDefault.setAttribute('disabled', true);
        document.querySelector('html').setAttribute('dir', 'rtl');
      } else {
        var linkRTL = document.getElementById('style-rtl');
        var userLinkRTL = document.getElementById('user-style-rtl');
        linkRTL.setAttribute('disabled', true);
        userLinkRTL.setAttribute('disabled', true);
      }
    </script>
    
    

  </head>


  <body>

    <!-- ===============================================-->
    <!--    Main Content-->
    <!-- ===============================================-->
    <main class="main" id="top">
      
      <div class="container" data-layout="container">
        <script>
          var isFluid = JSON.parse(localStorage.getItem('isFluid'));
          if (isFluid) {
            var container = document.querySelector('[data-layout]');
            container.classList.remove('container');
            container.classList.add('container-fluid');
          }
        </script>
        <nav class="navbar navbar-light navbar-vertical navbar-expand-xl">
          <script>
            var navbarStyle = localStorage.getItem("navbarStyle");
            if (navbarStyle && navbarStyle !== 'transparent') {
              document.querySelector('.navbar-vertical').classList.add(`navbar-${navbarStyle}`);
            }
          </script>
          <div class="d-flex align-items-center">
<!--            <div class="toggle-icon-wrapper">-->
<!--                <button class="btn navbar-toggler-humburger-icon navbar-vertical-toggle" data-bs-toggle="tooltip" data-bs-placement="left" title="Toggle Navigation"><span class="navbar-toggle-icon"><span class="toggle-line"></span></span></button>-->
<!--            </div>-->
              <a class="navbar-brand" href="../quiz/home">
                  <div class="d-flex align-items-center py-3"><img class="me-2" src="../../assets/img/icons/qp-transparent.png" alt="" width="55" /><span class="font-sans-serif">project</span>
                  </div>
              </a>
          </div>
        </nav>
        
        <div class="content">
          
          <nav class="navbar navbar-light navbar-glass navbar-top navbar-expand">
          
<!--            <button class="btn navbar-toggler-humburger-icon navbar-toggler me-1 me-sm-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarVerticalCollapse" aria-controls="navbarVerticalCollapse" aria-expanded="false" aria-label="Toggle Navigation"><span class="navbar-toggle-icon"><span class="toggle-line"></span></span></button>-->
<!--            <a class="navbar-brand me-1 me-sm-3" href="../../../index.html">-->
<!--              <div class="d-flex align-items-center"><img class="me-2" src="../../../assets/img/icons/spot-illustrations/falcon.png" alt="" width="40" /><span class="font-sans-serif">falcon</span>-->
<!--              </div>-->
<!--            </a>-->
          
            
            <ul class="navbar-nav navbar-nav-icons ms-auto flex-row align-items-center">
                <li class="nav-item dropdown">
                    <a class="nav-link pe-0 ps-2" id="navbarDropdownUser" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="avatar avatar-xl">
                            <img class="rounded-circle" src="../../../assets/img/icons/cookie.png" alt="" />
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-caret dropdown-menu-end py-0" aria-labelledby="navbarDropdownUser">
                        <div class="bg-white dark__bg-1000 rounded-2 py-2">
                            <!--                            <a class="dropdown-item fw-bold text-warning" href="#!"><span class="fas fa-crown me-1"></span><span>Go Pro</span></a>-->
                            <!--                            -->
                            <!--                            <div class="dropdown-divider"></div>-->
                            <!--                            <a class="dropdown-item" href="#!">Set status</a>-->
                            <!--                            <a class="dropdown-item" href="../../../pages/user/profile.html">Profile &amp; account</a>-->
                            <!--                            <a class="dropdown-item" href="#!">Feedback</a>-->
                            <!--                            -->
                            <!--                            <div class="dropdown-divider"></div>-->
                            <a class="dropdown-item" href="../auth/memberList">회원 관리</a>
                            <a class="dropdown-item" href="../auth/analytics">애널리틱스</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="../mypage/edit">마이페이지</a>
                            <a class="dropdown-item" href="../auth/logout">로그아웃</a>
                        </div>
                    </div>
                </li>
            </ul>
          </nav>
          
          <div class="row">
            <div class="col-xxl-10 col-xl-9">
              
              <div class="card mb-3" style="position:relative; z-index:10">
                
                <div class="bg-holder d-none d-lg-block bg-card" style="background-image:url(../../../assets/img/icons/spot-illustrations/corner-4.png);">
                </div>
                <!--/.bg-holder-->

                <div class="card-body pt-0 pt-md-3">
                    <span id="quizId" style="display:none" th:text="${quiz.quizzesId}"></span>
                  <h3 th:text="${quiz.quizzesTitle}">퀴즈 제목 여기에</h3>
                  <p class="mb-0" id="durationOrScore">소요 시간: <span id="minutes">0</span> 분 <span id="seconds">00</span> 초</p>
                </div>
                  <div class="progress mb-3" style="height:15px; margin: auto; width: 85%;">
                      <div class="progress-bar bg-primary progress-bar-striped" role="progressbar" style="width: 0%; overflow: hidden;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
              </div>
              
              <!-- 퀴즈설정 -->
                <form autocomplete="off" th:action="@{/quiz/generateQuiz}" method="post" th:if="${not #lists.isEmpty(questions)}" th:each="l, iterStat: ${questions}">
                    <div class="card mb-3 pt-0 pt-md-3" >
                        <div class="card-header">
                            <h5 class="mb-0">
                                <span class="qids" style = "display:none" th:text="${l.questionsId}">id</span>
                                <span th:text="[+${iterStat.index}+]"  style="ont-weight: bold; white-space: pre-line;"></span>
                                <span th:text="${l.questionsQuestion}"  style="ont-weight: bold; white-space: pre-line;"></span>
                            </h5>
                        </div>
                        <div class="card-body bg-light question-content">
                            <div class="row gx-2">
                                <div class="col-12 mb-3">
                                    <input  class="qrs form-control" name="quizzesTitle" type="text" required onchange ="progressChk();"/>
                                    <label class="answer form-label" id="birthdate-error-msg" style="color:red;"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
<!--                <div class="card mb-3" data-list='{"valueNames":["name","email","phone","address","joined"],"page":5,"pagination":true}'>-->
<!--                    <div class="card-header">-->
<!--                        <h5 class="mb-0"><b>질문 목록</b></h5>-->
<!--                    </div>-->
<!--                    <div class="card-body bg-light">-->
<!--                        <div class="row gx-2">-->
<!--                            <div class="table-responsive scrollbar">-->
<!--                                <table class="table" id="table-questions" >-->
<!--                                    <thead>-->
<!--                                    <tr class="btn-reveal-trigger">-->
<!--                                        <th scope="col">id (히든)</th>-->
<!--                                        <th scope="col">순서</th>-->
<!--                                        <th scope="col">질문</th>-->
<!--                                    </tr>-->
<!--                                    </thead>-->
<!--                                    <tbody id="tbody" th:each="l, iterStat: ${questions}">-->
<!--                                        <tr>-->
<!--                                            <td th:text="${l.questionsId}">34</td> &lt;!&ndash; 수정 및 삭제시 이 컬럼으로 조회할 것 &ndash;&gt;-->
<!--                                            <td th:text="${iterStat.index + 1}"><a href="#">index 자리</a></td>-->
<!--                                            <td><a href="#" th:text="${l.questionsQuestion}">대한민국의 수도는? (예시)</a></td>-->
<!--                                        </tr>-->
<!--                                    </tbody>-->
<!--                                </table>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="card-footer d-flex align-items-center justify-content-center">-->
<!--                            <button class="btn btn-sm btn-falcon-default me-1" type="button" title="Previous" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>-->
<!--                            <ul class="pagination mb-0"></ul>-->
<!--                            <button class="btn btn-sm btn-falcon-default ms-1" type="button" title="Next" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
            </div>
            
          </div>
          
        </div>
        
        <div class="modal fade" id="schedule-discount-modal" tabindex="-1" role="dialog" aria-labelledby="schedule-discount-modal-label" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header d-flex align-items-center border-bottom px-4">
                <h4 class="mb-0" id="schedule-discount-modal-label">Schedule for Discount </h4>
              </div>

              <div class="modal-footer border-top text-start py-2 px-4 d-flex justify-content-end">
                <button class="btn btn-outline-secondary btn-md" data-bs-dismiss="modal"> <span class="fas fa-times me-1 fs--1"></span>Cancel</button>
                <button class="btn btn-primary btn-md ms-2" type="submit"> <span class="fas fa-check me-1 fs--1"></span>Confirm</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!-- ===============================================-->
    <!--    End of Main Content-->
    <!-- ===============================================-->

    <!-- ===============================================-->
    <!--    JavaScripts-->
    <!-- ===============================================-->
    <script src="../../../vendors/popper/popper.min.js"></script>
    <script src="../../../vendors/bootstrap/bootstrap.min.js"></script>
    <script src="../../../vendors/anchorjs/anchor.min.js"></script>
    <script src="../../../vendors/is/is.min.js"></script>
    <script src="../../../vendors/tinymce/tinymce.min.js"></script>
    <script src="../../../vendors/choices/choices.min.js"></script>
    <script src="../../../assets/js/flatpickr.js"></script>
    <script src="../../../vendors/dropzone/dropzone.min.js"></script>
    <script src="../../../vendors/fontawesome/all.min.js"></script>
    <script src="../../../vendors/lodash/lodash.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=window.scroll"></script>
    <script src="../../../vendors/list.js/list.min.js"></script>
    <script src="../../../assets/js/theme.js"></script>
    <script src="../../../vendors/prism/prism.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../../../vendors/jquery/jquery.min.js"></script>
    <script src="../../../vendors/select2/select2.min.js"></script>
    <script src="../../../vendors/select2/select2.full.min.js"></script>
  
    <script>
        window.onload = function () {
 
          var minutes = 00;
          var seconds = 00;
          var tens = 00;
          var appendSeconds = document.getElementById("seconds");
          var appendMinutes = document.getElementById("minutes");
          
          var Interval ;
        
          clearInterval(Interval);
          Interval = setInterval(startTimer, 10);
          
          function startTimer () {
            tens++;
            
            if (tens > 99) {
              seconds++;
              appendSeconds.innerHTML = "0" + seconds;
              tens = 0;
            }
            
            if (seconds > 9){
              appendSeconds.innerHTML = seconds;
            }
            
            if (seconds > 59){
              minutes++;
              if (minutes < 10) {
                appendMinutes.innerHTML = "0" + minutes;
              }
              else {
                appendMinutes.innerHTML = minutes;
              }
              appendMinutes.innerHTML = minutes;
              seconds = 0;
              appendSeconds.innerHTML = "0" + 0;
            }
          }
        }
        
        // get last question content
        let elements = document.querySelectorAll('.question-content');
        let lastElement = elements[elements.length- 1];
        
        // append following button
        
        let quizId = document.querySelector("#quizId").innerHTML;
        let retakeUrl = 'http://localhost:8080/quiz/take/'+quizId;
        lastElement.insertAdjacentHTML('beforeend', `<div class='mb-3' id="submitBtn"><a class='btn btn-outline-primary d-block w-100 mt-3' onclick="submit();"> <b id="btnText">제출하기</b> </a></div>`);
        lastElement.insertAdjacentHTML('beforeend', `<div class='mb-3' id="retakeBtn" style="display:none" onclick="location.href = '${retakeUrl}'"><a class='btn btn-outline-primary d-block w-100 mt-3';> <b>다시 풀기</b> </a></div>`);
        lastElement.insertAdjacentHTML('beforeend', `<div class='mb-3' id="homeBtn" style="display:none" onclick="location.href = 'http://localhost:8080/quiz/home'"><a class='btn btn-outline-primary d-block w-100 mt-3';> <b>홈으로 이동</b> </a></div>`);
    
    // 퀴즈 시작시간
    let startTime = new Date($.now());
    
    function submit(){
        if (confirm('퀴즈를 제출하시겠습니까?')) {
          // memberId 와 quizId는 컨트롤러단에서 추가
        // 제출시간
        let endTime = new Date($.now());
        
        
        // get responses to get grade
        let quizId = document.querySelector("#quizId").innerHTML;
        let userResponse = {
            "quizId":quizId,
            "startTime": startTime.toJSON(),
            "endTime" : endTime.toJSON(),
            "questionIds":[],
            "responses":[],
        };

        let questionIds = document.querySelectorAll(".qids");
        let questionResponses = document.querySelectorAll(".qrs");
        
        let i = 0;
        
        for (i = 0; i < questionIds.length; i++) {
            userResponse.questionIds.push(questionIds[i].innerHTML);
        }
        for (i = 0; i < questionResponses.length; i++) {
            userResponse.responses.push(questionResponses[i].value);
        }
        
        console.log(userResponse);
        
        // 제출하기 버튼 => 나가기로.
        document.querySelector("#submitBtn").style.display = "none";
        document.querySelector("#retakeBtn").style.display = "block";
        document.querySelector("#homeBtn").style.display = "block";
        
        
        $.ajax({
            type : "POST", // http 방식
            url : "/quiz/submit", // ajax 통신 url
            data : JSON.stringify(userResponse),
            contentType: "application/json; charset=UTF-8",
            success : function(results) {
<!--                alert("퀴즈를 제출하였습니다.");-->
                //location.replace("http://localhost:8080/quiz/home")
                // 화면의 모든 input field readonly 로 바꾸면서 정답 여부 체크
                let inputs = document.querySelectorAll('.qrs');
                let corrects = 0;
                let answerLabels = document.querySelectorAll(".answer");
                for (i = 0; i < inputs.length; i++) {
                    if (results[i].resultOptionContent == inputs[i].value) {
                        // 정답
                        inputs[i].classList.add("is-valid");
                        corrects++;
                    }
                    else {
                        // 오답
                        inputs[i].classList.add("is-invalid");
                        answerLabels[i].innerHTML = "정답: "+results[i].resultOptionContent;
                    }
                    inputs[i].readOnly=true;
                }
                let userScore = corrects / inputs.length * 100;
                $("#durationOrScore").html("점수: "+userScore+" 점");
            }
        })
          
        } else {
          // Do nothing!
          return false;
        }
        
        
        
    }
    
    // progress check logic
    function progressChk(){
            let answers = document.querySelectorAll(".qrs");
            let total = answers.length;
            let count = 0;
            for(let i = 0; i < total; i ++){
                if (answers[i].value != "") {
                    count ++;
                };
            }
            let answered_rate = Math.round(count / total * 100) + "%";
            
            document.querySelector(".progress-bar").style.width = answered_rate;
        }
    </script>
    <style>
        .rounded-circle {
          transition: transform .7s ease-in-out; /* I moved this */
        }
        .rounded-circle:hover {
          transform: translate(0) rotate(360deg); /* I changed this */
        }
        
    </style>


  </body>

</html>